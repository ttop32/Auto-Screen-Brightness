using System;
using System.Management;
using Microsoft.UI.Xaml;
using Microsoft.UI.Xaml.Controls;
using Microsoft.UI.Xaml.Controls.Primitives;

namespace Auto_Screen_Brightness
{
    public sealed partial class MainWindow : Window
    {
        private TextBlock _currentBrightnessText;
        private Slider _brightnessSlider;
        private TextBlock _statusText;
        // Overlay UI        private ToggleSwitch _overlayToggle;        private Slider _overlaySlider;        public MainWindow()        {            // Build UI in code to avoid XAML generated code dependencies            var stack = new StackPanel            {                HorizontalAlignment = HorizontalAlignment.Center,                VerticalAlignment = VerticalAlignment.Center,                Width = 360,                Spacing = 12            };            var title = new TextBlock            {                Text = "Screen Brightness",                FontSize = 20,                HorizontalAlignment = HorizontalAlignment.Center            };            _currentBrightnessText = new TextBlock            {                Text = "Current: --%",                HorizontalAlignment = HorizontalAlignment.Center            };            _brightnessSlider = new Slider            {                Minimum = 0,                Maximum = 100,                SmallChange = 1,                LargeChange = 10            };            _brightnessSlider.ValueChanged += BrightnessSlider_ValueChanged;            var buttonsPanel = new StackPanel            {                Orientation = Orientation.Horizontal,                HorizontalAlignment = HorizontalAlignment.Center,                Spacing = 8            };            var applyButton = new Button { Content = "Apply" };            applyButton.Click += ApplyButton_Click;            var refreshButton = new Button { Content = "Refresh" };            refreshButton.Click += RefreshButton_Click;            buttonsPanel.Children.Add(applyButton);            buttonsPanel.Children.Add(refreshButton);            // Overlay controls            var overlayPanel = new StackPanel            {                Orientation = Orientation.Vertical,                Spacing = 6            };            var overlayHeader = new StackPanel            {                Orientation = Orientation.Horizontal,                HorizontalAlignment = HorizontalAlignment.Center,                Spacing = 8            };            _overlayToggle = new ToggleSwitch { Header = "Use Overlay" };            _overlayToggle.Toggled += OverlayToggle_Toggled;            overlayHeader.Children.Add(_overlayToggle);            _overlaySlider = new Slider            {                Minimum = 0,                Maximum = 100,                SmallChange = 1,                LargeChange = 10,                Value = 100            };            _overlaySlider.ValueChanged += OverlaySlider_ValueChanged;            var overlayHint = new TextBlock { Text = "Overlay brightness (perceived): 100% = no overlay", FontSize = 12 };            overlayPanel.Children.Add(overlayHeader);            overlayPanel.Children.Add(_overlaySlider);            overlayPanel.Children.Add(overlayHint);            _statusText = new TextBlock            {                Text = "Status: Ready",                TextWrapping = TextWrapping.Wrap            };            stack.Children.Add(title);            stack.Children.Add(_currentBrightnessText);            stack.Children.Add(_brightnessSlider);            stack.Children.Add(buttonsPanel);            stack.Children.Add(overlayPanel);            stack.Children.Add(_statusText);            var grid = new Grid { Padding = new Microsoft.UI.Xaml.Thickness(20) };            grid.Children.Add(stack);            Content = grid;            // Initialize brightness state after UI constructed            RefreshCurrentBrightness();        }        private void BrightnessSlider_ValueChanged(object sender, RangeBaseValueChangedEventArgs e)        {            _currentBrightnessText.Text = $"Current: {Convert.ToInt32(_brightnessSlider.Value)}%";        }        private void RefreshButton_Click(object sender, RoutedEventArgs e)        {            RefreshCurrentBrightness();        }        private void ApplyButton_Click(object sender, RoutedEventArgs e)        {            var level = Convert.ToInt32(_brightnessSlider.Value);            var success = TrySetBrightness(level, out var message);            _statusText.Text = success ? "Status: Brightness applied" : $"Status: Failed - {message}";            // Update overlay if running to match new target brightness            if (_overlayToggle != null && _overlayToggle.IsOn)            {                OverlayManager.UpdateOpacity(level);            }        }        private void OverlayToggle_Toggled(object sender, RoutedEventArgs e)        {            if (_overlayToggle.IsOn)            {                var val = Convert.ToInt32(_overlaySlider.Value);                OverlayManager.Start(val);                _statusText.Text = $"Status: Overlay enabled ({val}%)";            }            else            {                OverlayManager.Stop();                _statusText.Text = "Status: Overlay disabled";            }        }        private void OverlaySlider_ValueChanged(object sender, RangeBaseValueChangedEventArgs e)        {            var val = Convert.ToInt32(_overlaySlider.Value);            if (_overlayToggle != null && _overlayToggle.IsOn)            {                OverlayManager.UpdateOpacity(val);                _statusText.Text = $"Status: Overlay updated ({val}%)";            }        }        private void RefreshCurrentBrightness()        {            var (success, value, message) = TryGetCurrentBrightness();            if (success)            {                _brightnessSlider.Value = value;                // default overlay level to current brightness                if (_overlaySlider != null) _overlaySlider.Value = value;                _currentBrightnessText.Text = $"Current: {value}%";                _statusText.Text = "Status: Current brightness loaded";            }            else            {                _statusText.Text = $"Status: Failed to read - {message}";            }        }        // Reads current brightness using WmiMonitorBrightness (root\\wmi)        private (bool success, int value, string message) TryGetCurrentBrightness()        {            try            {                var scope = new ManagementScope(@"\\.\root\wmi");                scope.Connect();                var query = new SelectQuery("WmiMonitorBrightness");                using var searcher = new ManagementObjectSearcher(scope, query);                foreach (ManagementObject obj in searcher.Get())                {                    var current = obj.GetPropertyValue("CurrentBrightness");                    if (current != null && int.TryParse(current.ToString(), out var brightness))                    {                        return (true, brightness, string.Empty);                    }                }                return (false, 0, "No WmiMonitorBrightness instances found");            }            catch (Exception ex)            {                return (false, 0, ex.Message);            }        }        // Sets brightness using WmiMonitorBrightnessMethods.WmiSetBrightness (root\\wmi)        private bool TrySetBrightness(int level, out string message)        {            message = string.Empty;            try            {                // Level should be 0-100                level = Math.Clamp(level, 0, 100);                var scope = new ManagementScope(@"\\.\root\wmi");                scope.Connect();                using var mclass = new ManagementClass(scope, new ManagementPath("WmiMonitorBrightnessMethods"), new ObjectGetOptions());                foreach (ManagementObject obj in mclass.GetInstances())                {                    // WmiSetBrightness takes (Timeout:uint32, Brightness:uint32)                    var inParams = new object[] { (uint)1, (uint)level };                    obj.InvokeMethod("WmiSetBrightness", inParams);                }                return true;            }            catch (Exception ex)            {                message = ex.Message;                return false;            }        }    }}